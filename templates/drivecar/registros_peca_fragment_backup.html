{% load form_extras %}

<div class="fragment-header">
  <h4>Registros ‚Äî {{ peca.nome }} ({{ veiculo }})</h4>

  {% if saved %}
    <div class="notice success">Registro salvo com sucesso</div>
    <script>setTimeout(function(){var n=document.querySelector('.notice.success'); if(n) n.remove();}, 2500);</script>
  {% endif %}
</div>
<table class="records-table">
  <thead>
    <tr>
      <th>Data</th><th>KM</th><th>Pre√ßo</th><th>Troca</th><th>Garantia (meses)</th><th>Observa√ß√µes</th><th></th>
    </tr>
  </thead>
  <tbody>
    {% for r in registros %}
      <tr id="registro-{{ r.id }}" class="registro-row" data-registro-id="{{ r.id }}">
        <td>{{ r.data }}</td>
        <td>{{ r.km }}</td>
        <td>{{ r.preco }}</td>
        <td>{{ r.troca|yesno:"Sim,N√£o" }}</td>
        <td>{{ r.garantia_meses }}</td>
        <td>{{ r.observacoes }}</td>
        <td class="td-actions">
          <button type="button" class="btn-delete-registro" title="Excluir registro" onclick="
            if(confirm('‚ö†Ô∏è Deseja EXCLUIR este registro de manuten√ß√£o?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
              var btn = this;
              btn.disabled = true;
              btn.innerHTML = '‚è≥';
              var linha = document.getElementById('registro-{{ r.id }}');
              if(linha) linha.style.opacity = '0.5';
              
              var xhr = new XMLHttpRequest();
              xhr.open('POST', '/veiculo/{{ veiculo.id }}/peca/{{ peca.id }}/registro/{{ r.id }}/excluir/', true);
              xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
              xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
              xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
              
              xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                  if (xhr.status === 200) {
                    if(linha) {
                      linha.style.transition = 'all 0.3s ease';
                      linha.style.opacity = '0';
                      linha.style.transform = 'translateX(-20px)';
                      setTimeout(function() {
                        linha.remove();
                        var tbody = linha.closest('tbody');
                        if(tbody && tbody.querySelectorAll('tr:not(.empty-row)').length === 0) {
                          var emptyRow = document.createElement('tr');
                          emptyRow.innerHTML = '<td colspan=\'7\' style=\'text-align: center; color: #6b7280; font-style: italic;\'>Nenhum registro.</td>';
                          tbody.appendChild(emptyRow);
                        }
                      }, 300);
                    }
                    alert('‚úÖ Registro exclu√≠do com sucesso!');
                  } else {
                    btn.disabled = false;
                    btn.innerHTML = '<svg width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path d=\'M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z\'/></svg>';
                    if(linha) linha.style.opacity = '1';
                    alert('‚ùå Erro ao excluir registro. Tente novamente.');
                  }
                }
              };
              
              xhr.send('csrfmiddlewaretoken=' + encodeURIComponent(document.querySelector('[name=csrfmiddlewaretoken]').value));
            }
          ">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z"/>
            </svg>
          </button>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="7">Nenhum registro.</td></tr>
    {% endfor %}
  </tbody>
</table>

<form method="post" hx-post="{% url 'drivecar:registros_peca' veiculo.id peca.id %}" hx-target="#registros-{{ peca.id }}" class="registro-form">
  {% csrf_token %}
  <div class="form-grid">
    <div class="col col-2">
      <label class="field-label" for="id_data_{{ peca.id }}">Data</label>
      {{ form.data|add_class:'input input-sm' }}
    </div>
    <div class="col col-2">
      <label class="field-label" for="id_km_{{ peca.id }}">KM</label>
      {{ form.km|add_class:'input input-sm' }}
    </div>
    <div class="col col-2">
      <label class="field-label" for="id_preco_{{ peca.id }}">Pre√ßo</label>
      {{ form.preco|add_class:'input input-sm' }}
    </div>
    <div class="col col-1">
      <label class="field-label">Troca</label>
      <div class="inline-center">{{ form.troca }} </div>
    </div>
    <div class="col col-1">
      <label class="field-label" for="id_garantia_{{ peca.id }}">Garantia</label>
      {{ form.garantia_meses|add_class:'input input-xs' }}
    </div>
    <div class="col col-5">
      <label class="field-label" for="id_obs_{{ peca.id }}">Observa√ß√µes</label>
      {{ form.observacoes|add_class:'textarea textarea-sm' }}
    </div>

    <div class="col col-12">
      <button type="submit" class="btn-primary">[+] Adicionar registro</button>
    </div>
  </div>
</form>

<script>
/* eslint-disable */
/* Template Django - ignorar valida√ß√£o de linter */
console.log('üöÄ Script carregado para pe√ßa {{ peca.id }}');

// Dados do √∫ltimo registro para c√°lculos de alerta
var ULTIMO_KM = parseInt('{{ ultimo_km|default:0 }}') || 0;
var ULTIMA_DATA = '{% if ultima_data %}{{ ultima_data|date:"Y-m-d" }}{% endif %}' || null;

console.log('üîß Debug Alertas:', {
  ultimoKm: ULTIMO_KM,
  ultimaData: ULTIMA_DATA,
  ultimoKmOriginal: '{{ ultimo_km|default:0 }}',
  ultimaDataOriginal: '{% if ultima_data %}{{ ultima_data|date:"Y-m-d" }}{% endif %}'
});

// Inicializar sino ao carregar
document.addEventListener('DOMContentLoaded', function() {
  var pecaId = '{{ peca.id }}';
  var sino = document.getElementById('sino-' + pecaId);
  
  console.log('ÔøΩ Inicializando sino da pe√ßa:', pecaId);
  
  if (sino) {
    console.log('‚úÖ Sino encontrado:', sino.id);
    
    // Adicionar event listener ao inv√©s de onclick inline
    sino.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('üîî CLIQUE NO SINO DETECTADO!');
      
      // 1. Mudan√ßa visual imediata
      var estaAtivo = sino.classList.contains('ativo');
      
      if (estaAtivo) {
        // Desativar visualmente
        sino.classList.remove('ativo');
        sino.style.background = 'rgba(255, 255, 255, 0.8)';
        sino.style.borderColor = '#ddd';
        sino.style.filter = 'grayscale(100%)';
        sino.style.opacity = '0.4';
        sino.style.transform = 'scale(1)';
        sino.style.boxShadow = 'none';
        console.log('üîï Sino DESATIVADO visualmente');
      } else {
        // Ativar visualmente
        sino.classList.add('ativo');
        sino.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
        sino.style.borderColor = '#ffd700';
        sino.style.filter = 'grayscale(0%)';
        sino.style.opacity = '1';
        sino.style.transform = 'scale(1.05)';
        sino.style.boxShadow = '0 1px 4px rgba(255, 215, 0, 0.3)';
        console.log('üîî Sino ATIVADO visualmente');
      }
      
      // 2. Enviar para o backend
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/peca/' + pecaId + '/toggle_alerta/', true);
      
      // Token CSRF
      var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
      if (csrfToken) {
        xhr.setRequestHeader('X-CSRFToken', csrfToken.value);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        console.log('‚úÖ Headers configurados');
      }
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              var response = JSON.parse(xhr.responseText);
              console.log('‚úÖ Resposta:', response);
              
              if (response.success) {
                // Sincronizar visual com resposta do servidor
                if (response.alerta_ativo) {
                  sino.classList.add('ativo');
                  sino.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
                  sino.style.borderColor = '#ffd700';
                  sino.style.filter = 'grayscale(0%)';
                  sino.style.opacity = '1';
                  sino.style.transform = 'scale(1.05)';
                  sino.style.boxShadow = '0 1px 4px rgba(255, 215, 0, 0.3)';
                } else {
                  sino.classList.remove('ativo');
                  sino.style.background = 'rgba(255, 255, 255, 0.8)';
                  sino.style.borderColor = '#ddd';
                  sino.style.filter = 'grayscale(100%)';
                  sino.style.opacity = '0.4';
                  sino.style.transform = 'scale(1)';
                  sino.style.boxShadow = 'none';
                }
                
                // Notifica√ß√£o discreta
                var message = response.alerta_ativo ? 'üîî Alerta ativado' : 'üîï Alerta desativado';
                console.log(message);
              }
            } catch (e) {
              console.error('‚ùå Erro ao processar resposta:', e);
            }
          } else {
            console.error('‚ùå Erro HTTP:', xhr.status);
            // Reverter visual em caso de erro
            if (estaAtivo) {
              sino.classList.add('ativo');
            } else {
              sino.classList.remove('ativo');
            }
          }
        }
      };
      
      xhr.send();
      console.log('üì§ Requisi√ß√£o enviada para backend');
    });
    
    console.log('‚úÖ Event listener adicionado ao sino');
  } else {
    console.error('‚ùå Sino n√£o encontrado no DOM');
  }
});



// Fun√ß√£o global para exclus√£o
window.excluirRegistro = function(registroId) {
  console.log('üî• FUN√á√ÉO CHAMADA! ID:', registroId);
  alert('‚úÖ TESTE: Fun√ß√£o funcionou! Registro ID: ' + registroId);
  
  // Confirmar exclus√£o
  if (!confirm('‚ö†Ô∏è Deseja EXCLUIR este registro?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
    console.log('‚ùå Cancelado pelo usu√°rio');
    return false;
  }
  
  console.log('‚úÖ Confirmado! Excluindo registro:', registroId);
  
  // M√©todo 1: Formul√°rio simples (mais confi√°vel)
  var form = document.createElement('form');
  form.method = 'POST';
  form.action = '/veiculo/{{ veiculo.id }}/peca/{{ peca.id }}/registro/' + registroId + '/excluir/';
  form.style.display = 'none';
  
  // Token CSRF
  var csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
  form.appendChild(csrfInput);
  
  // Adicionar ao body
  document.body.appendChild(form);
  
  console.log('üì§ Enviando formul√°rio...');
  
  // Enviar
  form.submit();
  
  return false;
};

// Configurar formata√ß√£o de campos
setTimeout(function() {
  console.log('‚öôÔ∏è Configurando formata√ß√£o de campos...');
  
  var form = document.querySelector('#registros-{{ peca.id }} form.registro-form');
  if (form) {
    // ===== FORMATA√á√ÉO DO CAMPO KM =====
    var kmField = form.querySelector('input[name$="km"]');
    if (kmField) {
      console.log('üöó Campo KM encontrado, configurando formata√ß√£o');
      kmField.type = 'text';
      kmField.placeholder = 'Ex: 123.456,789';
      
      function formatarKM(valor) {
        var numero = valor.replace(/[^\d]/g, '');
        if (numero === '') return '';
        while (numero.length < 4) numero = '0' + numero;
        var parteInteira = numero.slice(0, -3);
        var decimais = numero.slice(-3);
        parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return parteInteira + ',' + decimais;
      }
      
      function obterValorNumericoKM(valorFormatado) {
        if (!valorFormatado) return '';
        return valorFormatado.replace(/\./g, '').replace(',', '.');
      }
      
      kmField.addEventListener('input', function(e) {
        var valorFormatado = formatarKM(e.target.value);
        e.target.value = valorFormatado;
        setTimeout(function() {
          e.target.setSelectionRange(valorFormatado.length, valorFormatado.length);
        }, 0);
      });
      
      form.addEventListener('submit', function() {
        var valorOriginal = kmField.value;
        var valorNumerico = obterValorNumericoKM(valorOriginal);
        kmField.value = valorNumerico;
        setTimeout(function() { kmField.value = valorOriginal; }, 100);
      });
    }
    
    // ===== FORMATA√á√ÉO DO CAMPO PRE√áO =====
    var precoField = form.querySelector('input[name$="preco"]');
    if (precoField) {
      console.log('üí∞ Campo Pre√ßo encontrado, configurando formata√ß√£o');
      precoField.type = 'text';
      precoField.placeholder = 'R$ 0,00';
      
      function formatarPreco(valor) {
        var numero = valor.replace(/[^\d]/g, '');
        if (numero === '') return 'R$ ';
        while (numero.length < 3) numero = '0' + numero;
        var centavos = numero.slice(-2);
        var reais = numero.slice(0, -2);
        reais = reais.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return 'R$ ' + reais + ',' + centavos;
      }
      
      function obterValorNumericoPreco(valorFormatado) {
        if (!valorFormatado || valorFormatado === 'R$ ') return '';
        return valorFormatado.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
      }
      
      precoField.addEventListener('input', function(e) {
        var valorFormatado = formatarPreco(e.target.value);
        e.target.value = valorFormatado;
        setTimeout(function() {
          e.target.setSelectionRange(valorFormatado.length, valorFormatado.length);
        }, 0);
      });
      
      precoField.addEventListener('focus', function(e) {
        if (e.target.value === '' || e.target.value === 'R$ 0,00') {
          e.target.value = 'R$ ';
        }
        setTimeout(function() {
          e.target.setSelectionRange(e.target.value.length, e.target.value.length);
        }, 10);
      });
      
      precoField.addEventListener('blur', function(e) {
        if (e.target.value === 'R$ ' || e.target.value === '') {
          e.target.value = '';
        }
      });
      
      if (precoField.value === '') {
        precoField.value = 'R$ ';
      }
      
      form.addEventListener('submit', function() {
        var valorOriginal = precoField.value;
        var valorNumerico = obterValorNumericoPreco(valorOriginal);
        if (valorNumerico) {
          precoField.value = valorNumerico;
        }
        setTimeout(function() { precoField.value = valorOriginal; }, 100);
      });
    }
  }
}, 300);

// SISTEMA DE ALERTAS INTEGRADO NO FORMUL√ÅRIO
window.toggleAlertaFields = function(pecaId) {
  console.log('üîî Toggle alerta para pe√ßa:', pecaId);
  
  var checkbox = document.getElementById('criar_alerta_' + pecaId);
  var fieldsDiv = document.getElementById('alerta_fields_' + pecaId);
  var hiddenField = document.querySelector('[name="alerta_ativo"]');
  var previewDiv = document.getElementById('preview_' + pecaId);
  
  if (!checkbox || !fieldsDiv) {
    console.error('‚ùå Elementos n√£o encontrados');
    return;
  }
  
  if (checkbox.checked) {
    // MOSTRAR campos de configura√ß√£o
    fieldsDiv.style.display = 'block';
    if (hiddenField) hiddenField.value = 'True';
    
    // Mostrar preview se h√° dados
    if (previewDiv) {
      updateAlertaPreview(pecaId);
    }
    
    console.log('‚úÖ Alerta ATIVADO - campos vis√≠veis');
  } else {
    // OCULTAR campos de configura√ß√£o
    fieldsDiv.style.display = 'none';
    if (hiddenField) hiddenField.value = '';
    
    // Ocultar preview
    if (previewDiv) {
      previewDiv.style.display = 'none';
    }
    
    console.log('‚ùå Alerta DESATIVADO - campos ocultos');
  }
};

// Fun√ß√£o para calcular e mostrar quando o alerta ser√° disparado
window.updateAlertaPreview = function(pecaId) {
  console.log('üîÑ updateAlertaPreview chamada para pe√ßa:', pecaId);
  
  var kmField = document.querySelector('[name="alerta_intervalo_km"]');
  var mesesField = document.querySelector('[name="alerta_intervalo_meses"]');
  var previewDiv = document.getElementById('preview_' + pecaId);
  var previewContent = document.getElementById('preview_content_' + pecaId);
  
  console.log('üìã Elementos encontrados:', {
    kmField: !!kmField,
    mesesField: !!mesesField,
    previewDiv: !!previewDiv,
    previewContent: !!previewContent
  });
  
  if (!previewDiv || !previewContent) {
    console.log('‚ùå Elementos preview n√£o encontrados');
    return;
  }
  
  var kmIntervalo = kmField ? parseInt(kmField.value) : 0;
  var mesesIntervalo = mesesField ? parseInt(mesesField.value) : 0;
  
  console.log('üìä Valores dos campos:', {
    kmIntervalo: kmIntervalo,
    mesesIntervalo: mesesIntervalo,
    ULTIMO_KM: ULTIMO_KM,
    ULTIMA_DATA: ULTIMA_DATA
  });
  
  var preview = [];
  
  // Calcular baseado em KM (usando √∫ltimo registro)
  if (kmIntervalo > 0 && ULTIMO_KM > 0) {
    var proximoKm = ULTIMO_KM + kmIntervalo;
    preview.push('üöó ' + proximoKm.toLocaleString('pt-BR') + ' KM');
    console.log('‚úÖ Adicionado c√°lculo KM:', proximoKm);
  }
  
  // Calcular baseado em tempo (usando √∫ltima data)
  if (mesesIntervalo > 0 && ULTIMA_DATA) {
    var dataBase = new Date(ULTIMA_DATA);
    var proximaData = new Date(dataBase);
    proximaData.setMonth(proximaData.getMonth() + mesesIntervalo);
    preview.push('üìÖ ' + proximaData.toLocaleDateString('pt-BR'));
    console.log('‚úÖ Adicionado c√°lculo Data:', proximaData.toLocaleDateString('pt-BR'));
  }
  
  console.log('üìù Preview final:', preview);
  
  if (preview.length > 0) {
    previewContent.innerHTML = preview.join(' ou ');
    previewDiv.style.display = 'block';
    console.log('‚úÖ Preview exibido:', preview.join(' ou '));
  } else {
    previewDiv.style.display = 'none';
    console.log('‚ùå Preview oculto - sem dados suficientes');
  }
};

// Inicializa√ß√£o e sincroniza√ß√£o do sistema de alertas
document.addEventListener('DOMContentLoaded', function() {
  var form = document.querySelector('form.registro-form');
  var pecaId = '{{ peca.id }}';
  
  if (form) {
    // Configurar listeners para preview em tempo real
    var kmField = form.querySelector('[name="alerta_intervalo_km"]');
    var mesesField = form.querySelector('[name="alerta_intervalo_meses"]');
    
    if (kmField) {
      kmField.addEventListener('input', function() {
        updateAlertaPreview(pecaId);
      });
    }
    
    if (mesesField) {
      mesesField.addEventListener('input', function() {
        updateAlertaPreview(pecaId);
      });
    }
    
  // Inicializar estado do alerta
  var checkbox = form.querySelector('[name="criar_alerta"]');
  var alertaSection = form.querySelector('.alerta-section');
  var alertaFields = form.querySelector('.alerta-fields');
  
  // Verificar se deve mostrar campos de alerta (dados existentes ou novo registro)
  if (checkbox && (checkbox.checked || (kmField && kmField.value) || (mesesField && mesesField.value))) {
    if (alertaSection) alertaSection.style.display = 'block';
    if (alertaFields) alertaFields.style.display = 'block';
    if (!checkbox.checked) checkbox.checked = true;
    updateAlertaPreview(pecaId);
  }    // Sincronizar campos no envio do formul√°rio
    form.addEventListener('submit', function() {
      var hiddenField = form.querySelector('[name="alerta_ativo"]');
      
      if (checkbox && hiddenField) {
        hiddenField.value = checkbox.checked ? 'True' : '';
        console.log('üìù Campo alerta_ativo definido como:', hiddenField.value);
      }
    });
  }
});

console.log('‚úÖ Script finalizado - Sistema de alertas integrado dispon√≠vel');
</script>