{% load form_extras %}

<!-- =================================== -->
<!-- CABEÇALHO DO FRAGMENTO             -->
<!-- =================================== -->
<div class="fragment-header">
  <h4>Registros — {{ peca.nome }} ({{ veiculo }})</h4>
  
  {% if saved %}
    <div class="notice success">Registro salvo com sucesso</div>
    <script>
      setTimeout(function() {
        var notice = document.querySelector('.notice.success');
        if (notice) notice.remove();
      }, 2500);
    </script>
  {% endif %}
</div>

<!-- =================================== -->
<!-- TABELA DE REGISTROS EXISTENTES     -->
<!-- =================================== -->
<table class="records-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Data</th>
      <th>KM</th>
      <th>Preço</th>
      <th>Troca</th>
      <th>Garantia (meses)</th>
      <th>Observações</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for registro in registros %}
      <tr id="registro-{{ registro.id }}" class="registro-row" data-registro-id="{{ registro.id }}">
        <td class="td-id">{{ forloop.counter }}</td>
        <td>{{ registro.data }}</td>
        <td>{{ registro.km }}</td>
        <td>{{ registro.preco }}</td>
        <td>{{ registro.troca|yesno:"Sim,Não" }}</td>
        <td>{{ registro.garantia_meses }}</td>
        <td>{{ registro.observacoes }}</td>
        <td class="td-actions">
          <button type="button" 
                  class="btn-delete-registro" 
                  title="Excluir registro"
                  onclick="excluirRegistro({{ registro.id }}, '{% url 'drivecar:excluir_registro' veiculo.id peca.id registro.id %}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z"/>
            </svg>
          </button>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="8" style="text-align: center; color: #6b7280; font-style: italic;">
          Nenhum registro encontrado.
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- =================================== -->
<!-- FORMULÁRIO PARA NOVO REGISTRO      -->
<!-- =================================== -->
<form method="post" 
      hx-post="{% url 'drivecar:registros_peca' veiculo.id peca.id %}" 
      hx-target="#registros-{{ peca.id }}" 
      class="registro-form">
  {% csrf_token %}
  
  <div class="form-grid">
    <!-- Data -->
    <div class="col col-2">
      <label class="field-label" for="id_data_{{ peca.id }}">Data</label>
      {{ form.data|add_class:'input input-sm' }}
    </div>
    
    <!-- KM -->
    <div class="col col-2">
      <label class="field-label" for="id_km_{{ peca.id }}">KM</label>
      {{ form.km|add_class:'input input-sm' }}
    </div>
    
    <!-- Preço -->
    <div class="col col-2">
      <label class="field-label" for="id_preco_{{ peca.id }}">Preço</label>
      {{ form.preco|add_class:'input input-sm' }}
    </div>
    
    <!-- Troca -->
    <div class="col col-1">
      <label class="field-label">Troca</label>
      <div class="inline-center">{{ form.troca }}</div>
    </div>
    
    <!-- Garantia -->
    <div class="col col-1">
      <label class="field-label" for="id_garantia_{{ peca.id }}">Garantia</label>
      {{ form.garantia_meses|add_class:'input input-xs' }}
    </div>
    
    <!-- Observações -->
    <div class="col col-5">
      <label class="field-label" for="id_obs_{{ peca.id }}">Observações</label>
      {{ form.observacoes|add_class:'textarea textarea-sm' }}
    </div>
    
    <!-- Botão Submit -->
    <div class="col col-12">
      <button type="submit" class="btn-primary">[+] Adicionar registro</button>
    </div>
  </div>
</form>

<!-- =================================== -->
<!-- SCRIPTS                             -->
<!-- =================================== -->
<script>
'use strict';

// JavaScript removido - usando apenas HTMX para exclusão

/**
 * Configuração de formatação automática dos campos
 */
setTimeout(function() {
  var form = document.querySelector('#registros-{{ peca.id }} form.registro-form');
  if (!form) return;
  
  // ===== FORMATAÇÃO DO CAMPO KM =====
  var kmField = form.querySelector('input[name$="km"]');
  if (kmField) {
    kmField.type = 'text';
    kmField.placeholder = 'Ex: 123.456,789';
    
    function formatarKM(valor) {
      var numero = valor.replace(/[^\d]/g, '');
      if (numero === '') return '';
      
      // Garantir pelo menos 4 dígitos para formatação
      while (numero.length < 4) numero = '0' + numero;
      
      var parteInteira = numero.slice(0, -3);
      var decimais = numero.slice(-3);
      
      // Adicionar pontos para milhares
      parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      return parteInteira + ',' + decimais;
    }
    
    function obterValorNumericoKM(valorFormatado) {
      if (!valorFormatado) return '';
      return valorFormatado.replace(/\./g, '').replace(',', '.');
    }
    
    // Event listener para formatação em tempo real
    kmField.addEventListener('input', function(e) {
      var valorFormatado = formatarKM(e.target.value);
      e.target.value = valorFormatado;
      
      // Manter cursor no final
      setTimeout(function() {
        e.target.setSelectionRange(valorFormatado.length, valorFormatado.length);
      }, 0);
    });
    
    // Converter para formato numérico antes do envio
    form.addEventListener('submit', function() {
      var valorOriginal = kmField.value;
      var valorNumerico = obterValorNumericoKM(valorOriginal);
      kmField.value = valorNumerico;
      
      // Restaurar formato visual após envio
      setTimeout(function() { 
        kmField.value = valorOriginal; 
      }, 100);
    });
  }
  
  // ===== FORMATAÇÃO DO CAMPO PREÇO =====
  var precoField = form.querySelector('input[name$="preco"]');
  if (precoField) {
    precoField.type = 'text';
    precoField.placeholder = 'R$ 0,00';
    
    function formatarPreco(valor) {
      var numero = valor.replace(/[^\d]/g, '');
      if (numero === '') return 'R$ ';
      
      // Garantir pelo menos 3 dígitos
      while (numero.length < 3) numero = '0' + numero;
      
      var centavos = numero.slice(-2);
      var reais = numero.slice(0, -2);
      
      // Adicionar pontos para milhares
      reais = reais.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      return 'R$ ' + reais + ',' + centavos;
    }
    
    function obterValorNumericoPreco(valorFormatado) {
      if (!valorFormatado || valorFormatado === 'R$ ') return '';
      return valorFormatado.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
    }
    
    // Event listener para formatação em tempo real
    precoField.addEventListener('input', function(e) {
      var valorFormatado = formatarPreco(e.target.value);
      e.target.value = valorFormatado;
      
      // Manter cursor no final
      setTimeout(function() {
        e.target.setSelectionRange(valorFormatado.length, valorFormatado.length);
      }, 0);
    });
    
    // Configurar valor inicial ao focar
    precoField.addEventListener('focus', function(e) {
      if (e.target.value === '' || e.target.value === 'R$ 0,00') {
        e.target.value = 'R$ ';
      }
      setTimeout(function() {
        e.target.setSelectionRange(e.target.value.length, e.target.value.length);
      }, 10);
    });
    
    // Limpar se vazio ao perder foco
    precoField.addEventListener('blur', function(e) {
      if (e.target.value === 'R$ ' || e.target.value === '') {
        e.target.value = '';
      }
    });
    
    // Inicializar campo vazio
    if (precoField.value === '') {
      precoField.value = 'R$ ';
    }
    
    // Converter para formato numérico antes do envio
    form.addEventListener('submit', function() {
      var valorOriginal = precoField.value;
      var valorNumerico = obterValorNumericoPreco(valorOriginal);
      if (valorNumerico) {
        precoField.value = valorNumerico;
      }
      
      // Restaurar formato visual após envio
      setTimeout(function() { 
        precoField.value = valorOriginal; 
      }, 100);
    });
  }
}, 300);
</script>