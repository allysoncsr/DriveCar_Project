{% load form_extras %}

<div class="fragment-header">
  <h4>Registros ‚Äî {{ peca.nome }} ({{ veiculo }})</h4>
  {% if saved %}
    <div class="notice success">Registro salvo com sucesso</div>
    <script>setTimeout(function(){var n=document.querySelector('.notice.success'); if(n) n.remove();}, 2500);</script>
  {% endif %}
</div>
<table class="records-table">
  <thead>
    <tr>
      <th>Data</th><th>KM</th><th>Pre√ßo</th><th>Troca</th><th>Garantia (meses)</th><th>Observa√ß√µes</th><th></th>
    </tr>
  </thead>
  <tbody>
    {% for r in registros %}
      <tr id="registro-{{ r.id }}" class="registro-row" data-registro-id="{{ r.id }}">
        <td>{{ r.data }}</td>
        <td>{{ r.km }}</td>
        <td>{{ r.preco }}</td>
        <td>{{ r.troca|yesno:"Sim,N√£o" }}</td>
        <td>{{ r.garantia_meses }}</td>
        <td>{{ r.observacoes }}</td>
        <td class="td-actions">
          <form method="post" action="{% url 'drivecar:excluir_registro' veiculo.id peca.id r.id %}" style="display: inline;" onsubmit="return confirmarExclusao();">
            {% csrf_token %}
            <button type="submit" class="btn-delete-registro" title="Excluir registro">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z"/>
              </svg>
            </button>
          </form>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="7">Nenhum registro.</td></tr>
    {% endfor %}
  </tbody>
</table>

<form method="post" hx-post="{% url 'drivecar:registros_peca' veiculo.id peca.id %}" hx-target="#registros-{{ peca.id }}" class="registro-form">
  {% csrf_token %}
  <div class="form-grid">
    <div class="col col-2">
      <label class="field-label" for="id_data_{{ peca.id }}">Data</label>
      {{ form.data|add_class:'input input-sm' }}
    </div>
    <div class="col col-2">
      <label class="field-label" for="id_km_{{ peca.id }}">KM</label>
      {{ form.km|add_class:'input input-sm' }}
    </div>
    <div class="col col-2">
      <label class="field-label" for="id_preco_{{ peca.id }}">Pre√ßo</label>
      {{ form.preco|add_class:'input input-sm' }}
    </div>
    <div class="col col-1">
      <label class="field-label">Troca</label>
      <div class="inline-center">{{ form.troca }} </div>
    </div>
    <div class="col col-1">
      <label class="field-label" for="id_garantia_{{ peca.id }}">Garantia</label>
      {{ form.garantia_meses|add_class:'input input-xs' }}
    </div>
    <div class="col col-6">
      <label class="field-label" for="id_obs_{{ peca.id }}">Observa√ß√µes</label>
      {{ form.observacoes|add_class:'textarea textarea-sm' }}
    </div>
    <div class="col col-12">
      <button type="submit" class="btn-primary">[+] Adicionar registro</button>
    </div>
  </div>
</form>

<script>
// Fun√ß√£o super simples e direta para exclus√£o
function excluirRegistroDireto(registroId) {
  console.log('ÔøΩÔ∏è Excluindo registro:', registroId);
  
  // Confirma√ß√£o
  if (!confirm('‚ùì Tem certeza que deseja excluir este registro?\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!')) {
    console.log('‚ùå Exclus√£o cancelada');
    return false;
  }
  
  // Encontrar a linha
  var linha = document.getElementById('registro-' + registroId);
  if (!linha) {
    alert('‚ùå Erro: Linha n√£o encontrada');
    return false;
  }
  
  console.log('‚úÖ Linha encontrada, enviando requisi√ß√£o...');
  
  // Anima√ß√£o de fade out imediata
  linha.style.transition = 'all 0.3s ease';
  linha.style.opacity = '0.5';
  linha.style.pointerEvents = 'none';
  
  // URL e dados
  var url = '/veiculo/{{ veiculo.id }}/peca/{{ peca.id }}/registro/' + registroId + '/excluir/';
  var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  // Requisi√ß√£o fetch simples
  fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrfToken
    },
    body: 'csrfmiddlewaretoken=' + encodeURIComponent(csrfToken)
  })
  .then(function(response) {
    console.log('üì° Resposta:', response.status);
    
    if (response.ok) {
      console.log('‚úÖ Exclu√≠do com sucesso!');
      
      // Animar e remover linha
      linha.style.opacity = '0';
      linha.style.transform = 'translateX(-20px)';
      
      setTimeout(function() {
        linha.remove();
        console.log('üóëÔ∏è Linha removida do DOM');
        
        // Verificar se precisa mostrar mensagem "nenhum registro"
        var tbody = linha.closest('tbody');
        var linhasRestantes = tbody.querySelectorAll('tr:not(.empty-row)');
        
        if (linhasRestantes.length === 0) {
          console.log('üìù Adicionando mensagem "nenhum registro"');
          var linhaVazia = document.createElement('tr');
          linhaVazia.className = 'empty-row';
          linhaVazia.innerHTML = '<td colspan="7" style="text-align: center; color: #6b7280; font-style: italic;">Nenhum registro.</td>';
          tbody.appendChild(linhaVazia);
        }
      }, 300);
      
    } else {
      console.error('‚ùå Erro:', response.status);
      alert('‚ùå Erro ao excluir registro. Tente novamente.');
      
      // Restaurar linha
      linha.style.opacity = '1';
      linha.style.pointerEvents = 'auto';
    }
  })
  .catch(function(error) {
    console.error('‚ùå Erro de conex√£o:', error);
    alert('‚ùå Erro de conex√£o. Tente novamente.');
    
    // Restaurar linha
    linha.style.opacity = '1';
    linha.style.pointerEvents = 'auto';
  });
  
  return false;
}

console.log('üöÄ Exclus√£o direta configurada para pe√ßa {{ peca.id }}');

// Configurar formata√ß√£o de campos e foco no formul√°rio
setTimeout(function() {
  var form = document.querySelector('#registros-{{ peca.id }} form.registro-form');
  if (form) {
    var first = form.querySelector('input[type="date"], input[type="number"], textarea');
    if (first) first.focus();
    
    // ===== FORMATA√á√ÉO DO CAMPO KM =====
    var kmField = form.querySelector('input[name$="km"]');
    if (kmField) {
      console.log('üöó Campo KM encontrado, configurando formata√ß√£o');
      
      // Mudamos o tipo para text para permitir formata√ß√£o visual
      kmField.type = 'text';
      kmField.placeholder = 'Ex: 123.456,789';
      
      // Fun√ß√£o para formatar KM com pontos e v√≠rgula
      function formatarKM(valor) {
        // Remove tudo que n√£o √© n√∫mero
        var numero = valor.replace(/[^\d]/g, '');
        
        if (numero === '') return '';
        
        // Adiciona zeros √† esquerda se necess√°rio para ter pelo menos 3 d√≠gitos
        while (numero.length < 4) {
          numero = '0' + numero;
        }
        
        // Separa em grupos: parte inteira e decimais
        var parteInteira = numero.slice(0, -3);
        var decimais = numero.slice(-3);
        
        // Formata parte inteira com pontos
        parteInteira = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        // Retorna formatado
        return parteInteira + ',' + decimais;
      }
      
      // Fun√ß√£o para obter valor num√©rico do KM
      function obterValorNumericoKM(valorFormatado) {
        if (!valorFormatado) return '';
        // Remove pontos e substitui v√≠rgula por ponto
        return valorFormatado.replace(/\./g, '').replace(',', '.');
      }
      
      // Evento de digita√ß√£o no campo KM
      kmField.addEventListener('input', function(e) {
        var valorDigitado = e.target.value;
        var valorFormatado = formatarKM(valorDigitado);
        
        console.log('üöó KM digitado:', valorDigitado, '‚Üí formatado:', valorFormatado);
        
        // Atualiza o campo visualmente
        e.target.value = valorFormatado;
        
        // Posiciona cursor no final
        setTimeout(function() {
          e.target.setSelectionRange(valorFormatado.length, valorFormatado.length);
        }, 0);
      });
      
      // Evento ao sair do campo (blur)
      kmField.addEventListener('blur', function(e) {
        var valorFormatado = e.target.value;
        var valorNumerico = obterValorNumericoKM(valorFormatado);
        console.log('üöó KM final:', valorFormatado, '‚Üí num√©rico:', valorNumerico);
      });
      
      // Antes do submit, preparar valor para envio
      form.addEventListener('submit', function() {
        var valorOriginal = kmField.value;
        var valorNumerico = obterValorNumericoKM(valorOriginal);
        
        // Temporarily change to numeric value for form submission
        kmField.value = valorNumerico;
        console.log('üöó Enviando KM:', valorOriginal, '‚Üí', valorNumerico);
        
        // Restore formatted value after a short delay
        setTimeout(function() {
          kmField.value = valorOriginal;
        }, 100);
      });
    }
    
    // ===== FORMATA√á√ÉO DO CAMPO PRE√áO =====
    var precoField = form.querySelector('input[name$="preco"]');
    if (precoField) {
      console.log('üí∞ Campo Pre√ßo encontrado, configurando formata√ß√£o');
      
      // Mudamos o tipo para text para permitir formata√ß√£o visual
      precoField.type = 'text';
      precoField.placeholder = 'R$ 0,00';
      
      // Fun√ß√£o para formatar pre√ßo brasileiro
      function formatarPreco(valor) {
        // Remove tudo que n√£o √© n√∫mero
        var numero = valor.replace(/[^\d]/g, '');
        
        if (numero === '') return 'R$ ';
        
        // Converte para centavos (adiciona zeros se necess√°rio)
        while (numero.length < 3) {
          numero = '0' + numero;
        }
        
        // Separa reais e centavos
        var centavos = numero.slice(-2);
        var reais = numero.slice(0, -2);
        
        // Adiciona pontos nos milhares
        reais = reais.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        // Retorna formatado
        return 'R$ ' + reais + ',' + centavos;
      }
      
      // Fun√ß√£o para obter valor num√©rico do pre√ß√£o
      function obterValorNumericoPreco(valorFormatado) {
        if (!valorFormatado || valorFormatado === 'R$ ') return '';
        // Remove R$, espa√ßos e pontos, substitui v√≠rgula por ponto
        return valorFormatado.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
      }
      
      // Evento de digita√ß√£o no campo Pre√ßo
      precoField.addEventListener('input', function(e) {
        var valorDigitado = e.target.value;
        var valorFormatado = formatarPreco(valorDigitado);
        
        console.log('üí∞ Pre√ßo digitado:', valorDigitado, '‚Üí formatado:', valorFormatado);
        
        // Atualiza o campo visualmente
        e.target.value = valorFormatado;
        
        // Mant√©m cursor no final
        setTimeout(function() {
          e.target.setSelectionRange(valorFormatado.length, valorFormatado.length);
        }, 0);
      });
      
      // Evento ao focar no campo
      precoField.addEventListener('focus', function(e) {
        if (e.target.value === '' || e.target.value === 'R$ 0,00') {
          e.target.value = 'R$ ';
          console.log('üí∞ Campo focado, definindo R$');
        }
        
        // Posiciona cursor no final
        setTimeout(function() {
          e.target.setSelectionRange(e.target.value.length, e.target.value.length);
        }, 10);
      });
      
      // Inicializar campo com R$ se estiver vazio
      if (precoField.value === '') {
        precoField.value = 'R$ ';
      }
      
      // Evento ao sair do campo (blur)
      precoField.addEventListener('blur', function(e) {
        var valorFormatado = e.target.value;
        var valorNumerico = obterValorNumericoPreco(valorFormatado);
        console.log('üí∞ Pre√ßo final:', valorFormatado, '‚Üí num√©rico:', valorNumerico);
        
        // Se campo vazio, voltar ao placeholder
        if (valorFormatado === 'R$ ' || valorFormatado === '') {
          e.target.value = '';
        }
      });
      
      // Antes do submit, preparar valor para envio
      form.addEventListener('submit', function() {
        var valorOriginal = precoField.value;
        var valorNumerico = obterValorNumericoPreco(valorOriginal);
        
        // Temporarily change to numeric value for form submission
        if (valorNumerico) {
          precoField.value = valorNumerico;
          console.log('üí∞ Enviando Pre√ßo:', valorOriginal, '‚Üí', valorNumerico);
        }
        
        // Restore formatted value after a short delay
        setTimeout(function() {
          precoField.value = valorOriginal;
        }, 100);
      });
    }
    
    console.log('Formata√ß√£o de campos configurada para pe√ßa {{ peca.id }}');
  }
}, 200);

console.log('Script carregado - Fun√ß√£o excluirRegistroManutencao dispon√≠vel:', typeof window.excluirRegistroManutencao);

// Debug - listar bot√µes ap√≥s carregamento
setTimeout(function() {
  var botoes = document.querySelectorAll('#registros-{{ peca.id }} .btn-delete-registro');
  console.log('Bot√µes de exclus√£o encontrados:', botoes.length);
  botoes.forEach(function(btn, i) {
    console.log('Bot√£o ' + (i+1) + ' - ID:', btn.getAttribute('data-registro-id'));
  });
}, 1000);
</script>
