{% extends "drivecar/base.html" %}
{% load humanize %}
{% block title %}Meus Ve√≠culos{% endblock %}
{% block content %}
<style>
/* ========== EFEITO MINIMALISTA DE CONTORNO PARA NOVO VE√çCULO ========== */
.vehicle-card {
  position: relative;
  transition: all 0.3s ease;
}

/* Contorno animado para ve√≠culo rec√©m-cadastrado */
.vehicle-card.new-vehicle-highlight {
  position: relative;
}

.vehicle-card.new-vehicle-highlight::before {
  content: '';
  position: absolute;
  top: -1px;
  left: -1px;
  right: -1px;
  bottom: -1px;
  border: 1px solid #48bb78;
  border-radius: inherit;
  z-index: 1;
  pointer-events: none;
  
  /* Anima√ß√£o do contorno */
  animation: newVehicleBorder 3s ease-out forwards;
}

@keyframes newVehicleBorder {
  0% {
    border-color: transparent;
    box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7);
  }
  10% {
    border-color: #48bb78;
    box-shadow: 0 0 0 4px rgba(72, 187, 120, 0.3);
  }
  50% {
    border-color: #48bb78;
    box-shadow: 0 0 0 8px rgba(72, 187, 120, 0.2);
  }
  90% {
    border-color: #48bb78;
    box-shadow: 0 0 0 0 rgba(72, 187, 120, 0);
  }
  100% {
    border-color: transparent;
    box-shadow: 0 0 0 0 rgba(72, 187, 120, 0);
  }
}

/* Remove o efeito ap√≥s a anima√ß√£o */
.vehicle-card.new-vehicle-highlight.fade-out::before {
  animation: fadeOutBorder 0.5s ease-out forwards;
}

@keyframes fadeOutBorder {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}
</style>

<h2>Meus ve√≠culos</h2>

<!-- Se√ß√£o de Alertas -->
{% if alertas_urgentes %}
<section class="alertas-section">
  <div class="alertas-header">
    <h3 class="alertas-title">üîî Alertas Ativos</h3>
    <span class="alertas-count">{{ alertas_urgentes|length }}</span>
  </div>
  
  <div class="alertas-grid">
    {% for alerta in alertas_urgentes %}
      <div class="alerta-card {{ alerta.urgencia }}">
        <span class="alerta-icon">{{ alerta.cor }}</span>
        <div class="alerta-content">
          <div class="alerta-veiculo">{{ alerta.veiculo.titulo_limpo }}</div>
          <div class="alerta-item">{{ alerta.item }}</div>
          <div class="alerta-status {{ alerta.urgencia }}">{{ alerta.status }}</div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<div class="vehicle-grid">
  {% for v in veiculos %}
    <article class="vehicle-card" data-vehicle-id="{{ v.id }}" data-marca="{{ v.marca.nome }}">
      <a class="vehicle-link" href="{% url 'drivecar:manutencao' v.id %}">
        <div class="vehicle-header">
          <div class="vehicle-title">{{ v.titulo_limpo }}</div>
        </div>
        <div class="vehicle-footer">
          <div class="vehicle-meta">{{ v.ano }} ‚Ä¢ {{ v.km_atual|intcomma }} km</div>
          <div class="vehicle-maintenance-cost">
            <span class="cost-label">üí∞ Total gasto:</span>
            <strong class="cost-value">{{ v.total_gasto_manutencao_formatado }}</strong>
          </div>
        </div>
      </a>
      <a href="{% url 'drivecar:excluir_veiculo' v.id %}" class="delete-btn" title="Excluir ve√≠culo" onclick="return confirm('Tem certeza que deseja excluir este ve√≠culo?')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.315c0 .901.73 2 1.631 2h5.712z"/>
        </svg>
      </a>
    </article>
  {% empty %}
    <p>Nenhum ve√≠culo cadastrado.</p>
  {% endfor %}
</div>

<!-- Mensagens do Django (processadas pelo JavaScript) -->
{% if messages %}
  <div id="django-messages" style="display: none;">
    {% for message in messages %}
      <div data-type="{{ message.tags }}" data-message="{{ message|escape }}"></div>
    {% endfor %}
  </div>
{% endif %}

<script>
// ========== SISTEMA MINIMALISTA DE CONTORNO PARA NOVO VE√çCULO ==========
class NewVehicleBorderEffect {
  constructor() {
    this.processedMessages = new Set();
    this.init();
  }

  init() {
    // Processar mensagens do Django no carregamento da p√°gina
    this.processDjangoMessages();
  }

  processDjangoMessages() {
    const djangoMessages = document.getElementById('django-messages');
    if (djangoMessages) {
      const messages = djangoMessages.querySelectorAll('[data-message]');
      messages.forEach(msgElement => {
        const type = msgElement.getAttribute('data-type') || 'info';
        const message = msgElement.getAttribute('data-message');
        
        // Verificar se √© uma mensagem de cadastro de ve√≠culo
        if (message && message.includes('cadastrado com sucesso') && type === 'success') {
          this.showNewVehicleEffect(message);
        }
      });
    }
  }

  showNewVehicleEffect(message) {
    // Extrair nome da marca da mensagem
    const marcaMatch = message.match(/Ve√≠culo\s+([^0-9]+)/i);
    if (!marcaMatch) return;
    
    const marcaNome = marcaMatch[1].trim().split(' ')[0]; // Pegar apenas a primeira palavra (marca)
    
    // Encontrar o card do ve√≠culo mais recente dessa marca
    const vehicleCards = document.querySelectorAll('.vehicle-card[data-marca]');
    let targetCard = null;
    
    // Procurar o card mais recente da marca (√∫ltimo no DOM)
    for (let i = vehicleCards.length - 1; i >= 0; i--) {
      const card = vehicleCards[i];
      const cardMarca = card.getAttribute('data-marca');
      if (cardMarca && cardMarca.toLowerCase().includes(marcaNome.toLowerCase())) {
        targetCard = card;
        break;
      }
    }
    
    if (!targetCard) {
      // Se n√£o encontrar por marca, usar o √∫ltimo card (mais recente)
      targetCard = vehicleCards[vehicleCards.length - 1];
    }
    
    if (targetCard) {
      this.animateBorderEffect(targetCard);
    }
  }

  animateBorderEffect(card) {
    // Adicionar classe de efeito de contorno
    card.classList.add('new-vehicle-highlight');
    
    // Remover o efeito ap√≥s 3 segundos
    setTimeout(() => {
      card.classList.add('fade-out');
      
      // Remover todas as classes ap√≥s fade out
      setTimeout(() => {
        card.classList.remove('new-vehicle-highlight', 'fade-out');
      }, 500);
    }, 3000);
  }

  // M√©todo p√∫blico para mostrar efeito manualmente
  showEffect(marca, vehicleId = null) {
    let targetCard;
    
    if (vehicleId) {
      targetCard = document.querySelector(`.vehicle-card[data-vehicle-id="${vehicleId}"]`);
    } else {
      // Procurar por marca
      const cards = document.querySelectorAll('.vehicle-card[data-marca]');
      for (let card of cards) {
        if (card.getAttribute('data-marca').toLowerCase().includes(marca.toLowerCase())) {
          targetCard = card;
          break;
        }
      }
    }
    
    if (targetCard) {
      this.animateBorderEffect(targetCard);
    }
  }
}

// Inicializar sistema quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
  window.newVehicleBorder = new NewVehicleBorderEffect();
});
</script>
{% endblock %}
